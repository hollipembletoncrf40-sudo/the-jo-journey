---
import '@unocss/reset/tailwind.css';
import 'uno.css';

interface Props {
  title: string;
  description?: string;
}

const { title, description = '探索技术、分享思考的个人博客' } = Astro.props;
---

<!doctype html>
<html lang="zh-CN" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{title}</title>
    <style is:global>
      /* 全局背景 - 点阵效果 */
      html {
        background-color: #0a0a0a;
        background-image: 
          radial-gradient(circle at 1px 1px, rgba(255,255,255,0.03) 1px, transparent 0);
        background-size: 24px 24px;
      }
      
      /* 滚动条样式 */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(125,125,125,0.3);
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(125,125,125,0.5);
      }
      
      /* 选中文字样式 */
      ::selection {
        background: rgba(99, 102, 241, 0.3);
      }
    </style>
  </head>
  <body class="min-h-screen text-gray-200 font-sans antialiased">
    <div class="flex flex-col min-h-screen">
      <!-- 顶部导航栏 -->
      <header class="fixed top-0 left-0 right-0 z-50 backdrop-blur-md bg-[#0a0a0a]/80 border-b border-gray-800/50">
        <nav class="container-base h-14 flex-between">
          <!-- Logo -->
          <a href="/" class="text-lg font-medium opacity-90 hover:opacity-100 transition-opacity italic">
            The Jo Journey
          </a>
          
          <!-- 导航链接 -->
          <div class="flex items-center gap-6">
            <a href="/blog" class="nav-link">博客</a>
            <a href="/projects" class="nav-link">项目</a>
            <a href="/about" class="nav-link">关于</a>
            <a href="/contact" class="nav-link">联系</a>
            
            <!-- 图标按钮组 -->
            <div class="flex items-center gap-3 ml-2 border-l border-gray-800 pl-4">
              <button id="search-btn" class="nav-icon" aria-label="搜索">
                <span class="i-lucide-search text-lg"></span>
              </button>
              <a href="https://github.com" target="_blank" class="nav-icon" aria-label="GitHub">
                <span class="i-lucide-github text-lg"></span>
              </a>
              <a href="/rss" class="nav-icon" aria-label="RSS">
                <span class="i-lucide-rss text-lg"></span>
              </a>
            </div>
          </div>
        </nav>
      </header>

      <!-- 主内容区 -->
      <main class="flex-1 container-base pt-24 pb-16">
        <slot />
      </main>

      <!-- 页脚 -->
      <footer class="border-t border-gray-800/50 py-8">
        <div class="container-base flex-between text-sm text-dimmer">
          <span>© {new Date().getFullYear()} Josephine</span>
          <span>使用 Astro 构建</span>
        </div>
      </footer>
    </div>

    <!-- 搜索对话框 -->
    <div id="search-dialog" class="fixed inset-0 z-100 hidden">
      <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" id="search-overlay"></div>
      <div class="absolute top-24 left-1/2 -translate-x-1/2 w-full max-w-xl px-4">
        <div class="bg-[#111] border border-gray-800 rounded-xl p-4 shadow-2xl">
          <div class="flex items-center gap-3">
            <span class="i-lucide-search text-gray-500"></span>
            <input 
              type="text" 
              id="search-input"
              placeholder="搜索文章..." 
              class="flex-1 bg-transparent border-none outline-none text-gray-200 placeholder-gray-600"
              autofocus
            />
            <kbd class="text-xs text-gray-600 bg-gray-800 px-2 py-1 rounded">ESC</kbd>
          </div>
          <div id="search-results" class="mt-4 max-h-80 overflow-y-auto">
            <p class="text-center text-gray-600 py-6 text-sm">输入关键词开始搜索</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Pagefind 搜索脚本 -->
    <script is:inline>
      // 搜索对话框控制
      const searchBtn = document.getElementById('search-btn');
      const searchDialog = document.getElementById('search-dialog');
      const searchOverlay = document.getElementById('search-overlay');
      const searchInput = document.getElementById('search-input');
      const searchResults = document.getElementById('search-results');

      let pagefind = null;
      let pagefindLoaded = false;

      async function initPagefind() {
        if (pagefindLoaded) return;
        pagefindLoaded = true;
        
        try {
          pagefind = await import('/pagefind/pagefind.js');
          await pagefind.init();
        } catch (e) {
          pagefind = null;
          console.log('Pagefind not available');
        }
      }

      function openSearch() {
        searchDialog.classList.remove('hidden');
        searchInput.focus();
        initPagefind();
      }

      function closeSearch() {
        searchDialog.classList.add('hidden');
        searchInput.value = '';
        searchResults.innerHTML = '<p class="text-center text-gray-600 py-6 text-sm">输入关键词开始搜索</p>';
      }

      async function performSearch(query) {
        if (!query.trim()) {
          searchResults.innerHTML = '<p class="text-center text-gray-600 py-6 text-sm">输入关键词开始搜索</p>';
          return;
        }

        if (!pagefind) {
          searchResults.innerHTML = '<p class="text-center text-gray-500 py-6 text-sm">搜索功能需要部署后才能使用</p>';
          return;
        }

        searchResults.innerHTML = '<p class="text-center text-gray-500 py-6 text-sm">搜索中...</p>';

        try {
          const search = await pagefind.search(query);
          const results = await Promise.all(search.results.slice(0, 8).map(r => r.data()));

          if (results.length === 0) {
            searchResults.innerHTML = '<p class="text-center text-gray-500 py-6 text-sm">没有找到相关结果</p>';
            return;
          }

          searchResults.innerHTML = results.map(result => `
            <a href="${result.url}" class="block p-3 rounded-lg hover:bg-gray-800/50 transition-colors border-b border-gray-800/50 last:border-0">
              <div class="font-medium text-gray-200 mb-1">${result.meta?.title || '无标题'}</div>
              <div class="text-sm text-gray-500 line-clamp-2">${result.excerpt}</div>
            </a>
          `).join('');
        } catch (e) {
          searchResults.innerHTML = '<p class="text-center text-gray-500 py-6 text-sm">搜索出错，请稍后重试</p>';
        }
      }

      searchBtn.addEventListener('click', openSearch);
      searchOverlay.addEventListener('click', closeSearch);
      
      let debounceTimer;
      searchInput.addEventListener('input', function(e) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(function() {
          performSearch(e.target.value);
        }, 300);
      });
      
      document.addEventListener('keydown', function(e) {
        if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
          e.preventDefault();
          openSearch();
        }
        if (e.key === 'Escape') {
          closeSearch();
        }
      });
    </script>
  </body>
</html>
